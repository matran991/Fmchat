function disable_input(t){var a=$("form input");1==t?a.attr("disabled","disabled"):a.removeAttr("disabled")}function connect(){$.get("/chatbox").done(function(t){1==/connected to use the ChatBox/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Vui lòng đăng nhập để chat</strong></div>'):1==/banned/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Bạn đã bị cấm truy cập chatbox</strong></div>'):(tid=t.match(/new Chatbox\(\"(.+)\"\,.+/)[1],update(),disable_input(!1),1==firsttime&&(autoUpdate(),firsttime=!1))})}function update(){$.get("/chatbox/actions.forum?archives=1&avatar=1&method=connect&tid="+tid).done(function(t){check_chat(t),data=t})}function new_obj(){pri_msg="",obj_msg="",pri_msg=new Object,pri_msg.length=0,obj_msg=new Object,obj_msg.length=0}function show_publist(){$(".chatbox-content").hide(),box_publist.show(),$("#chatbox-header h2").text("Kênh chung"),$("#chatbox-form").attr("data-key","publish")}function check_chat(t){var a=t;new_obj(),"object"==typeof a&&(0==a.connected?connect():1==a.connected&&($("#chatbox-me h2").text(Uname),list_user(a.users),list_msg(a.messages),getnumber()))}function hide_tab(){var t,a,e,s=$(this);s.toggleClass(function(){s.hasClass("show")?(t=-271,a=-1,e="hide"):(t=0,a=270,e="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a)})}function JsonString(t){try{JSON.parse(t)}catch(a){return!1}return JSON.parse(t)}function list_user(t){for(var a="",e=0;e<t.length;e++){var s=t[e],o=s.username,n=keychat(Uname,o);o==Uname&&s.id==Uid&&(level_chat=s.chatLevel,level_admin=s.admin,User_color=s.color);var c='<li data-id="'+n+'" onclick="tool_mod.call(this)" class="'+s.online+'" data-lv="'+s.chatLevel+'" data-id="'+s.id+'" data-name="'+o+'" data-color="'+s.color+'" data-online="'+s.online+'">';c+='<h3 style="color:'+s.color+'">'+o+"</h3>",c+='<span class="chatbox-change-mess" data-mess="0"></span>',c+="</li>",Uname==o&&(c=""),a+=c}$("#chatbox-members ul").html(a),1==getstore()&&setstore("","","","","","set")}function tool_mod(){var t=$(this),a=t.attr("data-name"),e=t.attr("data-id"),s=t.attr("data-online"),o=t.attr("data-color"),n=t.attr("data-lv"),c="",i=keychat(Uname,a),r=$(this).offset().top;if(a!=Uname&&e!=Uid){var c='<p class="mod-menu"><a href="javascript:;" onclick="toolhide.call(this)">Đóng Lại</a></p>';c+='<p class="mod-menu"><a href="/u'+e+'">Xem lý lịch</a></p>',c+='<p class="mod-menu"><a href="/privmsg?mode=post&u='+e+'">Gửi tin nhắn riêng.</a></p>',c+='<p class="mod-menu"><span onclick="chat_pri(\''+i+"','"+a+"','"+Uname+"','"+s+"','"+o+"')\">Chat Riêng</span></p>",2==level_chat&&1==level_admin&&(c+="<p class=\"mod-menu\"><span onclick=\"mod_tool('ban','"+a+"')\">Cấm vào chatbox</span></p>",c+=2==n?"<p class=\"mod-menu\"><span onclick=\"mod_tool('unmod','"+a+"')\">Hạ chức mod</span></p>":"<p class=\"mod-menu\"><span onclick=\"mod_tool('mod','"+a+"')\">Lên chức mod</span></p>"),$(".tool_mod").show().css("top",r).html(c)}}function keychat(t,a){for(var e=t+a,s=e.split(""),o="",n=0;n<s.length;n++)o+=s[n].charCodeAt(0);return o}function toolhide(){$(this).closest(".tool_mod").hide()}function chat_pri(t,a,e,s,o){$(".tool_mod").hide(),$("#chatbox-form").attr("data-key",t).attr("data-color",o),$("#chatbox-title h2").html("Chat cùng <strong>"+a+"</strong>");var n=$('.chatbox-content[data-id="'+t+'"]'),c=$('.chatbox-change[data-name="'+a+'"]');if($(".chatbox-content").hide(),c.length>0){var i=c.attr("onclick").match(/\'(\d+)\'.+/);if(null!=i)var i=i[1]}var r=n.length;if(r>0)n.show();else if(0==c.length)setstore(t,a,e,s,o,"save"),add_tab(t,a,e,s,o,"display:block");else{$(".chatbox-content").hide();var l=$('.chatbox-content[data-id="'+i+'"]');l.length>0&&(l.show(),$("#chatbox-form").attr("data-key",i).attr("data-color",o))}}function setobj(t,a,e,s,o,n){return t.key=a,t.lname=e,t.Uname=s,t.onl=o,t.color=n,t}function setstore(t,a,e,s,o,n){if("object"!=typeof data_chat_pri){data_chat_pri=new Object,data_chat_pri[0]=new Object,data_chat_pri.length=1;var c=data_chat_pri[0],c=setobj(c,t,a,e,s,o)}else for(var i=data_chat_pri.length,r=0;i>r;r++){var l=data_chat_pri[r],h=l.key;if("save"==n){if(h!=t){data_chat_pri[i]=new Object;var c=data_chat_pri[i],c=setobj(c,t,a,e,s,o);data_chat_pri.length=i+1}}else add_tab(l.key,l.lname,e,"",l.color,"display:none")}var c=JSON.stringify(data_chat_pri);localStorage.setItem("strore_chat",c)}function add_tab(t,a,e,s,o,n){var c=$('.chatbox-content[data-id="'+t+'"]');if(0==c.length){var i='<div class="chatbox-content" style="'+n+'" data-id="'+t+'"></div>';$wrap.append(i)}var r=$('#chatbox-members .pri-msg[data-name="'+a+'"]'),l=$('#chatbox-members li[data-name="'+a+'"]'),h=l.attr("class");if(0==r.length&&a!=e){void 0==h&&(h="false");var m='<div data-id="'+t+'" onclick="chat_pri(\''+t+"','"+a+"','"+e+"','"+h+"','"+o+'\')" class="chatbox-change '+h+' pri-msg" data-name="'+a+'">';m+='<h3 style="color:'+o+'"><span class="pri_use_name">'+a+"</span>",m+='<span class="number_pri"></span><span class="chatbox-change-mess" data-mess="0"></span></h3>',m+="</div>",$("#chatbox-members").append(m),setstore(t,a,e,h,o,"save")}else void 0==h&&(h="false"),r.removeClass("true").addClass(h);r.length==l.length?r.hide():r.show()}function getstore(){var t=localStorage.getItem("strore_chat");return null!=t?(data_chat_pri=JSON.parse(t),!0):!1}function show_box(){box_publist.show(),$("#chatbox-form").attr("data-key","")}function mod_tool(t,a){$(".tool_mod").hide();var e="/"+t+" "+a;send_msg("publish","","","","","","","",e)}function checkobj(t){return void 0!=t?t:""}function list_msg(t){for(var a=t.length,e=0;a>e;e++){var s=t[e],o=s.action;if("msg"==o||"clear"==o){var n=s,c=s.user;if(1==/key|lname|Uname/.test(n.msg))creat_obj_msg_pri(n,c);else{if("clear"==o){var c=new Object;c.color=0,c.avatar=0}creat_obj_msg(n,c)}}e==a-1&&(corver_obj_data(pri_msg,!1),corver_obj_data(obj_msg,!0),setTimeout(function(){$wrap.scrollTop(99999)},300))}}function creat_obj_msg(t,a){var e=obj_msg.length;obj_msg[e]=new Object,obj_msg[e].date=t.date,obj_msg[e].time=t.datetime,obj_msg[e].color=checkobj(a.color),obj_msg[e].avata=checkobj(a.avatar),obj_msg[e].name=t.username,obj_msg[e].msg=t.msg,obj_msg[e].id=t.userId,obj_msg.length=e+1}function creat_obj_msg_pri(t,a){if(1==/(.+)(\{.+\})(.+)/.test(t.msg))var e=t.msg.match(/(.+)(\{.+\})(.+)/),s=e[1],o=e[3],e=e[2];else if(1==/(\{.+\})/.test(t.msg))var e=t.msg.match(/(\{.+\})/),s="",o="",e=e[1];var e=JsonString(e);if(0!=e){var n=e.lname;if(n==Uname||1==check_key(e.key)){var c=e.key,i=s+e.msg+o,i=i.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," <img src='$1'></img> "),r=e.color,l=pri_msg.length;pri_msg[l]=new Object;var h=pri_msg[l];h.key=c,h.date=t.date,h.time=t.datetime,h.color=checkobj(a.color),h.lcolor=r,h.avata=checkobj(a.avatar),h.name=t.username,h.msg=i,h.lname=n,h.id=t.userId,pri_msg.length=l+1}}}function check_key(t){if("object"==typeof data_chat_pri){var a=data_chat_pri.length;if(a>0)for(var e=0;a>e;e++){var s=data_chat_pri[e];if(s.key==t)return!0}}}function corver_obj_data(t,a){var e="";0==a&&$(".chatbox-content").not('[data-id="publish"]').html("");for(var s=t.length,o=0;s>o;o++){var n=t[o],c=n.time.split(" "),i=c[0],r=c[1],l="";if(-1==e.indexOf(r)&&(l+='<p class="chatbox-date">'+r+"</p>",time_save=r),0==/Messages cleared by/.test(n.msg)?(l+='<p class="chatbox_row_'+(o%2==1?2:1)+' clearfix">',l+='<span class="user-msg">',l+='<span class="user-time">['+i+"] </span>",1==/png|jpeg|jpg|gif/.test(n.avata)&&(l+='<span class="cb-avatar"><img src="'+n.avata+'"></span>'),l+='<span class="user">',l+='<span class="chatbox-username chatbox-message-username">',l+='<a style="color:'+n.color+'" onclick="return copy_name(\''+n.name+'\')" href="/u'+n.id+'">'+n.name+"</a>",l+="</span>&nbsp;:&nbsp;</span>",l+='<span class="msg">'+n.msg+"</span>",l+="</span></p>"):l+='<p class="clear_msg"><strong><i class="fa fa-eraser"></i> '+n.name+" đã xóa chatbox.</strong></p>",e+=l,void 0!=n.key&&0==a){add_tab(n.key,n.name,Uname,"",n.color,"display:none");var h=$('.chatbox-content[data-id="'+n.key+'"]');h.append(l)}}1==a&&(box_publist.html(e),$('.chatbox-change[data-id="publish"] .chatbox-change-mess').html("<strong>"+s+"</strong>"))}function autoUpdate(){refreshFunction=setInterval(function(){update()},5e3)}function input_val(t){var a=($(""+t).attr("name"),$(""+t).serialize());return a}function copy_name(t){return $messenger[0].value+=t,$messenger.focus(),!1}function set_input(){var t=$(this).attr("class"),a=$(this).attr("data"),e=$('#chatbox-form input[name="'+a+'"]');"active"==t?($(this).removeClass("active"),e.attr("value",""),$messenger.css(input_style[a][0],input_style[a][2])):($(this).addClass("active"),e.attr("value","on"),$messenger.css(input_style[a][0],input_style[a][1]))}function chooseColor(t){$("#chatbox-option-color").css("background",t),$("#chatbox-input-color").val("#"+t.slice(1)),$("#chatbox-messenger").css("color",t)}function send_msg(t,a,e,s,o,n,c,i,r){if($messenger.val("").focus(),"publish"==t)var r=r.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," [img]$1[/img] "),l=r;else var h={key:t,lname:a,msg:r,color:e},l=JSON.stringify(h);var l=encodeURIComponent(l),m="message="+l;m+="&"+n,m+="&"+c,m+="&"+s,m+="&"+i,m+="&"+o,m+="&method=send&archives=1",$.ajax({url:"/chatbox/actions.forum",type:"post",data:m,dataType:"json",cache:!1,success:function(t){check_chat(t)}})}function smile_get(){var t=$(this).find("#frame-smile");if(0==t.find("img").length){for(var a="",e=26,s=1;e>s;s++){var o='<img src="'+link_smile+s+'.gif" onclick="smile_send(\''+s+"')\" />";a+=o}t.html(a)}var n=t.attr("class");"active"==n?(t.removeClass("active"),$(this).removeClass("active")):(t.addClass("active"),$(this).addClass("active"))}function exit(){var t=$(this).attr("class");1==/active/.test(t)?connect():($(this).addClass("active"),clearInterval(refreshFunction),$messenger.val("/exit").submit().val(""))}function getnumber(){$(".chatbox-content").each(function(){var t=$(this).find(".clearfix").length;if(t>0)var t="<strong>"+t+"</strong>";else var t="";var a=$(this).attr("data-id"),e=$('#chatbox-tabs .pri-msg[data-id="'+a+'"]').attr("data-name");$('#chatbox-tabs [data-id="'+a+'"] .chatbox-change-mess,#chatbox-tabs [data-name="'+e+'"] .chatbox-change-mess').html(t)})}function smile_send(t){var a=$("#chatbox-form").attr("data-key"),e=link_smile+t+".gif";send_msg(a,"","","","","","","",e)}var error_log,$wrap=$("#chatbox-wrap"),time_save="";box_publist=$('.chatbox-content[data-id="publish"]'),new_obj();var color_num=0,link_smile="https://cdn.rawgit.com/matran991/Fmchat/master/smile/",firsttime=!0,$messenger=$("#chatbox-messenger-input"),input_style={bold:{0:"font-weight",1:"bold",2:"normal"},italic:{0:"font-style",1:"italic",2:"normal"},underline:{0:"text-decoration",1:"underline",2:"inherit"},strike:{0:"text-decoration",1:"line-through",2:"inherit"}};$.get("/post").done(function(a){eval(a.split('if(typeof(_userdata) == "undefined")')[1].split('_userdata["user_level"]')[0]),Uname=_userdata.username,Uid=_userdata.user_id,connect()}),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-option-color").click(function(){color_num+=1;var t=function(t,a,e){return(e?arguments.callee(t,a,e-1):"#")+a[t.floor(t.random()*a.length)]}(Math,"0123456789ABCDEF",5);10==color_num&&(t="#333333",color_num=0),chooseColor(t)}),$messenger.on("input",function(){var t=this.value;this.value=t.replace(/\[\/(b|i|u|strike|left|center|right|justify|size|color|img|url|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)\]|\[(\*|hr)\]/gi,"")}),$("#chatbox-form").submit(function(t){t.preventDefault();var a=$(this).attr("data-key"),e=$("#chatbox-title h2 strong").text(),s=$(this).attr("data-color"),o=input_val("#chatbox-input-bold"),n=input_val("#chatbox-input-italic"),c=input_val("#chatbox-input-underline"),i=input_val("#chatbox-input-strike"),r=input_val("#chatbox-input-color"),l=$messenger.val();send_msg(a,e,s,o,n,c,i,r,l)});
