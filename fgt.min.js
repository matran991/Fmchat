function mstring(t){for(var a,e="",s=0,o=t.length;o>s;s+=1)a=t.charCodeAt(s),e+=a.toString(16)+"|";return e}function mhex(t){for(var a,e=t.split("|"),s="",o=0,n=e.length;n>o;o+=1)a=String.fromCharCode(parseInt(e[o],16)),s+=a;return s}function disable_input(t){var a=$("form input");1==t?a.attr("disabled","disabled"):a.removeAttr("disabled")}function connect(){$.get("/chatbox").done(function(t){1==/connected to use the ChatBox/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Vui lòng đăng nhập để chat</strong></div>'):1==/banned/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Bạn đã bị cấm truy cập chatbox</strong></div>'):(tid=t.match(/new Chatbox\(\"(.+)\"\,.+/)[1],update(),disable_input(!1),1==firsttime&&autoUpdate())})}function update(){$.get("/chatbox/actions.forum?archives=1&avatar=1&method=connect&tid="+tid).done(function(t){data=t,check_chat(t)})}function new_obj(){pri_msg="",obj_msg="",line_pri="",pri_msg=new Object,pri_msg.length=0,obj_msg=new Object,line_pri=new Object,obj_msg.length=0}function show_publist(){$(".chatbox-content").hide(),box_publist.show(),$("#chatbox-header h2").text("Kênh chung"),$("#chatbox-form").attr("data-key","publish"),$messenger.focus()}function check_chat(t){var a=t;new_obj(),"object"==typeof a&&(0==a.connected?connect():1==a.connected&&($("#chatbox-me h2").text(Uname),list_user(a.users),list_msg(a.messages),$(".chatbox-content").not('[data-id="publish"]').each(function(){var t=$(this).attr("data-id");void 0!=line_pri[t]&&void 0!=t&&corver_obj_data(line_pri[t],t)})))}function hide_tab(){var t,a,e,s=$(this);s.toggleClass(function(){s.hasClass("show")?(t=-271,a=-1,e="hide"):(t=0,a=270,e="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a)})}function JsonString(t){try{JSON.parse(t)}catch(a){return!1}return JSON.parse(t)}function list_user(t){for(var a="",e=0;e<t.length;e++){var s=t[e],o=s.username,n=$('.pri-msg[data-name="'+o+'"]').attr("data-id"),i="onclick=\"chat_pri('"+n+"','"+o+"','"+Uname+"','"+s.online+"','"+s.color+"')\"";if(void 0==n){keychat(Uname,o);var i=""}o==Uname&&s.id==Uid&&(level_chat=s.chatLevel,level_admin=s.admin,User_color=s.color);var r="<li "+i+' data-id="'+n+'" onmousedown="tool_mod.call(this)" class="'+s.online+'" data-lv="'+s.chatLevel+'" data-lid="'+s.id+'" data-name="'+o+'" data-color="'+s.color+'" data-online="'+s.online+'">';r+='<h3 style="color:'+s.color+'">'+o+"</h3>",r+='<span class="chatbox-change-mess" data-mess="0"></span>',r+="</li>",Uname==o&&(r=""),a+=r}$("#chatbox-members ul").html(a),1==getstore()&&setstore("","","","","","set")}function tool_mod(){var t=$(this);t.on("contextmenu",function(a){var e=t.attr("data-name"),s=t.attr("data-lid"),o=t.attr("data-online"),n=t.attr("data-color"),i=t.attr("data-lv"),r="",c=$('.pri-msg[data-name="'+e+'"]').attr("data-id");if(void 0==c)var c=keychat(Uname,e);var l=$(this).offset().top;if(e!=Uname&&s!=Uid){var r='<p class="mod-menu"><a href="javascript:;" onclick="toolhide.call(this)">Đóng Lại</a></p>';r+='<p class="mod-menu"><a target="_blank" href="/u'+s+'">Xem lý lịch</a></p>',r+='<p class="mod-menu"><a target="_blank" href="/privmsg?mode=post&u='+s+'">Gửi tin nhắn riêng.</a></p>',r+='<p class="mod-menu"><span onclick="chat_pri(\''+c+"','"+e+"','"+Uname+"','"+o+"','"+n+"')\">Chat Riêng</span></p>",2==level_chat&&1==level_admin&&(r+="<p class=\"mod-menu\"><span onclick=\"mod_tool('ban','"+e+"')\">Cấm vào chatbox</span></p>",r+=2==i?"<p class=\"mod-menu\"><span onclick=\"mod_tool('unmod','"+e+"')\">Hạ chức mod</span></p>":"<p class=\"mod-menu\"><span onclick=\"mod_tool('mod','"+e+"')\">Lên chức mod</span></p>"),$(".tool_mod").show().css("top",l).html(r)}return!1})}function keychat(t,a){for(var e=t+a,s=e.split(""),o="",n=0;n<s.length;n++)o+=s[n].charCodeAt(0);return o}function toolhide(){$(this).closest(".tool_mod").hide()}function chat_pri(t,a,e,s,o){$(".tool_mod").hide(),$("#chatbox-form").attr("data-key",t).attr("data-color",o),$("#chatbox-title h2").html("Chat cùng <strong>"+a+"</strong>");var n=$('.chatbox-content[data-id="'+t+'"]'),i=$('.chatbox-change[data-name="'+a+'"]');if(i.length>0){var r=i.attr("onclick").match(/\'(\d+)\'.+/);if(null!=r)var r=r[1]}if($(".chatbox-content").hide(),n.show(),0==i.length)setstore(t,a,e,s,o,"save"),add_tab(t,a,e,s,o,"display:block");else{$(".chatbox-content").hide();var c=$('.chatbox-content[data-id="'+r+'"]');c.length>0&&(c.show(),$("#chatbox-form").attr("data-key",r).attr("data-color",o),$messenger.focus())}}function setobj(t,a,e,s,o,n){return t.key=a,t.lname=e,t.Uname=s,t.onl=o,t.color=n,t}function setstore(t,a,e,s,o,n){if("object"!=typeof data_chat_pri){data_chat_pri=new Object,data_chat_pri[0]=new Object,data_chat_pri.length=1;var i=data_chat_pri[0],i=setobj(i,t,a,e,s,o)}else for(var r=data_chat_pri.length,c="",l=0;r>l;l++){var m=data_chat_pri[l];if("save"==n){if(m.key==t&&(c+="false"),l==r-1&&0==/false/.test(c)){data_chat_pri[r]=new Object;var i=data_chat_pri[r],i=setobj(i,t,a,e,s,o);data_chat_pri.length=r+1}}else add_tab(m.key,m.lname,e,"",m.color,"display:none")}var i=JSON.stringify(data_chat_pri);localStorage.setItem("strore_chat",i)}function add_tab(t,a,e,s,o,n){var i=$('.chatbox-content[data-id="'+t+'"]');if(0==i.length){var r='<div class="chatbox-content" style="'+n+'" data-id="'+t+'"></div>';$wrap.append(r)}var c=$('#chatbox-members .pri-msg[data-name="'+a+'"]'),l=$('#chatbox-members li[data-name="'+a+'"]'),m=l.attr("class");if(0==c.length&&a!=e){void 0==m&&(m="false");var h='<div data-id="'+t+'" onclick="chat_pri(\''+t+"','"+a+"','"+e+"','"+m+"','"+o+'\')" class="chatbox-change '+m+' pri-msg" data-name="'+a+'">';h+='<h3 style="color:'+o+'"><span class="pri_use_name">'+a+"</span>",h+='<span class="number_pri"></span><span class="chatbox-change-mess" data-mess="0"></span></h3>',h+="</div>",$("#chatbox-members").append(h),setstore(t,a,e,m,o,"save")}else void 0==m&&(m="false"),c.removeClass("true").addClass(m);c.length==l.length?c.hide():c.show()}function getstore(){var t=localStorage.getItem("strore_chat");return null!=t?(data_chat_pri=JSON.parse(t),!0):!1}function mod_tool(t,a){$(".tool_mod").hide();var e="/"+t+" "+a;send_msg("publish","","","","","","","",e)}function checkobj(t){return void 0!=t?t:""}function list_msg(t){for(var a=t.length,e=0;a>e;e++){var s=t[e],o=s.action;if("msg"==o||"clear"==o){var n=s,i=s.user;if(1==/key|lname|Uname/.test(n.msg))creat_obj_msg_pri(n,i);else{if("clear"==o){var i=new Object;i.color=0,i.avatar=0}creat_obj_msg(n,i)}}}corver_obj_data(obj_msg,"publish")}function creat_obj_msg(t,a){var e=obj_msg.length;obj_msg[e]=new Object,obj_msg[e].date=t.date,obj_msg[e].time=t.datetime,obj_msg[e].color=checkobj(a.color),obj_msg[e].avata=checkobj(a.avatar),obj_msg[e].name=t.username,obj_msg[e].msg=t.msg,obj_msg[e].buzz=!1,obj_msg[e].id=t.userId,obj_msg.length=e+1}function creat_obj_msg_pri(t,a){if(1==/(.+)(\{.+\})(.+)/.test(t.msg))var e=t.msg.match(/(.+)(\{.+\})(.+)/),s=e[1],o=e[3],e=e[2];else if(1==/(\{.+\})/.test(t.msg))var e=t.msg.match(/(\{.+\})/),s="",o="",e=e[1];var e=JsonString(e);if(0!=e){var n=e.lname;if(n==Uname||1==check_key(e.key)){var i=e.key,r=mhex(e.msg),r=s+r+o,r=r.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," <img src='$1'></img> "),c=e.color;void 0==line_pri[i]&&(line_pri[i]=new Object,line_pri[i].length=0);var l=line_pri[i].length;line_pri[i][l]=new Object;var m=line_pri[i][l];m.key=i,m.date=t.date,m.time=t.datetime,m.color=checkobj(a.color),m.lcolor=c,m.avata=checkobj(a.avatar),m.name=t.username,m.msg=r,m.lname=n,m.id=t.userId,m.buzz=!1,line_pri[i].length=l+1,add_tab(i,t.username,Uname,"",c,"display:none")}}}function check_key(t){if("object"==typeof data_chat_pri){var a=data_chat_pri.length;if(a>0)for(var e="",s=0;a>s;s++){var o=data_chat_pri[s];if(e+=o.key==t?"true":"",s==a-1)return 1==/true/.test(e)?!0:!1}}}function html_block(t,a,e){var s=t.time.split(" "),o=s[0],n=s[1],i="";if(n!=lastdate&&(i+='<p class="chatbox-date">'+n+"</p>",lastdate=n),0==/Messages cleared by/.test(t.msg)){1==/\/BUZZ/.test(t.msg)&&(t.msg='<img src="https://cdn.rawgit.com/matran991/Fmchat/master/smile/chatbuzz.gif">',t.buzz=!0),i+='<p class="chatbox_row_'+(e%2==1?2:1)+' clearfix">',i+='<span class="user-msg">',i+='<span class="user-time">['+o+"] </span>",1==/png|jpeg|jpg|gif/.test(t.avata)&&(i+='<span class="cb-avatar"><img src="'+t.avata+'"></span>'),i+='<span class="user">',i+='<span class="chatbox-username chatbox-message-username">',i+='<a style="color:'+t.color+'" onclick="return copy_name(\''+t.name+'\')" href="/u'+t.id+'">'+t.name+"</a>",i+="</span>&nbsp;:&nbsp;</span>";var r=$(t.msg);if("object"==typeof r){var c=r.html();if(1==regex_smile.test(c)){var l=c.match(regex_smile),m=smile_reg(l,c);r.html(m),t.msg=r.prop("outerHTML")}}i+='<span class="msg">'+t.msg+"</span>",i+="</span></p>"}else i+='<p class="clear_msg"><strong><i class="fa fa-eraser"></i> '+t.name+" đã xóa chatbox.</strong></p>";return i}function corver_obj_data(t,a){var e=t.length;if("publish"==a)var s=max_mess;else{void 0==max_pri[a]&&(max_pri[a]=new Object,max_pri[a].max=0);var s=max_pri[a].max}var o=$('.chatbox-content[data-id="'+a+'"]');$("#chatbox-title .new-mess");s>e&&(s=0);var n=e-s;if(e>s&&1==n){var i=e-1,r=t[i],c=o.html(),l=html_block(r,c,e);"publish"==a?max_mess=e:max_pri[a].max=e,1==firsttime||1==/Messages cleared/.test(r.msg)&&-10==r.id?(o.html(l),firsttime=!1):(1==r.buzz?($("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3)):$("#chatbox-new-mess")[0].play(),o.append(l),1==autoscroll&&$wrap.animate({scrollTop:$wrap.prop("scrollHeight")},"200","swing"))}else if(e>s&&n>1){for(var m="",i=s;e>i;i++){var r=t[i],h=html_block(r,m,i);m+=h}1==firsttime?(o.html(m),firsttime=!1):(o.append(m),$("#chatbox-new-mess")[0].play(),1==autoscroll&&$wrap.animate({scrollTop:$wrap.prop("scrollHeight")},"200","swing")),"publish"==a?max_mess=e:max_pri[a].max=e}if("publish"==a)var e=e-1;e>0?$('[data-id="'+a+'"] .chatbox-change-mess').html("<strong>"+e+"</strong>"):$('[data-id="'+a+'"] .chatbox-change-mess').html("")}function autoUpdate(){refreshFunction=setInterval(function(){update()},3e3)}function input_val(t){var a=($(""+t).attr("name"),$(""+t).serialize());return a}function copy_name(t){return $messenger[0].value+=t,$messenger.focus(),!1}function set_input(){var t=$(this).attr("class"),a=$(this).attr("data"),e=$('#chatbox-form input[name="'+a+'"]');"active"==t?($(this).removeClass("active"),e.attr("value",""),$messenger.css(input_style[a][0],input_style[a][2])):($(this).addClass("active"),e.attr("value","on"),$messenger.css(input_style[a][0],input_style[a][1]))}function chooseColor(t){$("#chatbox-option-color").css("background",t),$("#chatbox-input-color").val("#"+t.slice(1)),$("#chatbox-messenger").css("color",t)}function send_msg(t,a,e,s,o,n,i,r,c){if($messenger.val("").focus(),"publish"==t)var c=c.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," [img]$1[/img] "),l=c;else var m={key:t,lname:a,msg:mstring(c),color:e,clear:!1},l=JSON.stringify(m);var l=encodeURIComponent(l),h="message="+l;h+="&"+n,h+="&"+i,h+="&"+s,h+="&"+r,h+="&"+o,h+="&method=send&archives=1",$.ajax({url:"/chatbox/actions.forum",type:"post",data:h,dataType:"json",cache:!1,success:function(t){check_chat(t)}})}function getalt(t){for(var a in smile)if(t==smile[a])return a}function smile_reg(t,a){for(var e=t.length,s=0;e>s;s++){var o=t[s];if(void 0!=smile[o])var n='<span class="smiley_FB" style="background-position: 0 -'+smile[o]+'px"></span>',a=a.replace(o,n)}return a}function smile_get(){var t=$(this).find("#frame-smile");if(0==t.find("img").length){for(var a="",e=29,s=0,o=1;e>o;o++){var n=getalt(s),i='<span data="'+n+'" onclick="smile_send.call(this)" class="smiley_FB" style="background-position: 0 -'+s+'px"></span>';a+=i,s+=17}t.html(a)}var r=t.attr("class");"active"==r?(t.removeClass("active"),$(this).removeClass("active")):(t.addClass("active"),$(this).addClass("active"))}function exit(){var t=$(this).attr("class");1==/active/.test(t)?connect():($(this).addClass("active"),clearInterval(refreshFunction),$messenger.val("/exit").submit().val(""))}function checkd(t){if(mstring(location.host)==regexchar){var a='Uname = "'+Uname+'";Uid = '+Uid+";connect()";localStorage.setItem("_userdata",a),connect()}else connect=""}function smile_send(t){var a=($("#chatbox-form").attr("data-key")," "+$(this).attr("data"));$messenger[0].value+=a,$messenger.focus()}function filter_mess(t){var a=/\[\/?(?:b|i|u|strike|left|center|right|justify|size|color|img|url|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)*?.*?\]/gi;return 1==a.test(t)?t.replace(a,""):!1}function disable_buzz(){var t=$("#chatbox-option-buzz");if("BUZZ"===t.html()){var a,e=59;t.addClass("disable"),t.html(60),a=setInterval(function(){var s=e--;t.html(s),0>=s&&(clearInterval(a),t.removeClass("disable"),e=59,a=void 0,t.html("BUZZ"))},1e3)}}console.log("%c Ê! Làm gì đó","font-weight:bold;color: red;text-shadow: 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black;font-size:60px"),console.log("%c Tính rip của chú à. Coi chừng chú xẻo cu bây giờ.","font-weight:bold;font-size:20px"),console.log("%c Đừng có giỡn mặt với chú nghe chưa!.","font-weight:bold;font-size:20px");var $wrap=$("#chatbox-wrap");box_publist=$('.chatbox-content[data-id="publish"]');var color_num=0,regexchar="77|77|77|2e|66|6f|72|75|6d|67|69|61|69|74|72|69|2e|6e|65|74|",lastdate="",smile={"o.O":0,"O.o":17,":'(":34,"3:)":51,":(":68,":O":85,"8)":102,":D":119,"&gt;:(":136,"&lt;3":153,"^_^":170,":*":187,":v":204,'&lt;(")':221,":poop:":238,":putnam:":255,"(^^^)":272,":)":289,"-_-":306,"8|":323,":P":340,":/":357,"&gt;:O":374,";)":391,"(y)":408,":3":425,":|]":442,"O:)":459},firsttime=!0,line_pri=new Object,max_mess=0,max_pri=new Object,autoscroll=!0,regex_smile=/\bO:\)\B|\bo\.O\b|\bO\.o\b|\b8\|\B|\b8\)\B|\b3:\)\B|\B(\(y\)\B|\B:3\b|\B:\'\(\B|\B:\(\B|\B:O\b|\B:D\b|\B&gt;:\(\B|\B&lt;3\b|\B\^_\^\B|\B:\*\B|\B:v\b|\B&lt;\(\"\)\B|\B:poop:\B|\B:putnam:\B|\B\(\^\^\^\)\B|\B:\)\B|\B-_-\B|\B:P\b|\B:\/\B|\B&gt;:O\b|\B;\)\B|\B:\|\]\B)/gi,$messenger=$("#chatbox-messenger-input"),input_style={bold:{0:"font-weight",1:"bold",2:"normal"},italic:{0:"font-style",1:"italic",2:"normal"},underline:{0:"text-decoration",1:"underline",2:"inherit"},strike:{0:"text-decoration",1:"line-through",2:"inherit"}};new_obj(),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-input-autoscroll").change(function(){autoscroll=$(this).prop("checked")?!0:!1}),$("#chatbox-option-color").click(function(){color_num+=1;var t=function(t,a,e){return(e?arguments.callee(t,a,e-1):"#")+a[t.floor(t.random()*a.length)]}(Math,"0123456789ABCDEF",5);10==color_num&&(t="#333333",color_num=0),chooseColor(t)}),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/BUZZ"),$("#chatbox-form").submit(),disable_buzz())}),$("#chatbox-form").submit(function(t){t.preventDefault();var a=$(this).attr("data-key"),e=$("#chatbox-title h2 strong").text(),s=$(this).attr("data-color"),o=input_val("#chatbox-input-bold"),n=input_val("#chatbox-input-italic"),i=input_val("#chatbox-input-underline"),r=input_val("#chatbox-input-strike"),c=input_val("#chatbox-input-color"),l=$messenger.val();0==filter_mess(l)?l.length>0&&send_msg(a,e,s,o,n,i,r,c,l):$messenger.val(filter_mess(l)).focus()}),$(function(){var check=localStorage.getItem("_userdata");null!=check?mstring(location.host)==regexchar&&eval(check):$.get("/post").done(function(a){eval(a.split('if(typeof(_userdata) == "undefined")')[1].split('_userdata["user_level"]')[0]),Uname=_userdata.username,Uid=_userdata.user_id,checkd(a)})});
