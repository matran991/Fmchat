function disable_input(t){var a=$("form input");1==t?a.attr("disabled","disabled"):a.removeAttr("disabled")}function connect(){$.get("/chatbox").done(function(t){1==/connected to use the ChatBox/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Vui lòng đăng nhập để chat</strong></div>'):1==/banned/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Bạn đã bị cấm truy cập chatbox</strong></div>'):(tid=t.match(/new Chatbox\(\"(.+)\"\,.+/)[1],update(),disable_input(!1),1==firsttime&&(autoUpdate(),firsttime=!1))})}function update(){$.get("/chatbox/actions.forum?archives=1&avatar=1&method=connect&tid="+tid).done(function(t){check_chat(t)})}function new_obj(){pri_msg="",obj_msg="",pri_msg=new Object,pri_msg.length=0,obj_msg=new Object,obj_msg.length=0}function show_publist(){$(".chatbox-content").hide(),box_publist.show(),$("#chatbox-header h2").text("Kênh chung"),$("#chatbox-form").attr("data-key","publish")}function check_chat(t){var a=t;new_obj(),"object"==typeof a&&(0==a.connected?connect():1==a.connected&&($("#chatbox-me h2").text(Uname),list_user(a.users),list_msg(a.messages),getnumber()))}function hide_tab(){var t,a,e,n=$(this);n.toggleClass(function(){n.hasClass("show")?(t=-271,a=-1,e="hide"):(t=0,a=270,e="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a)})}function JsonString(t){try{JSON.parse(t)}catch(a){return!1}return JSON.parse(t)}function list_user(t){for(var a="",e=0;e<t.length;e++){var n=t[e],o=n.username,s=keychat(Uname,o);o==Uname&&n.id==Uid&&(level_chat=n.chatLevel,level_admin=n.admin,User_color=n.color);var r='<li data-id="'+s+'" onclick="tool_mod.call(this)" class="'+n.online+'" data-lv="'+n.chatLevel+'" data-lid="'+n.id+'" data-name="'+o+'" data-color="'+n.color+'" data-online="'+n.online+'">';r+='<h3 style="color:'+n.color+'">'+o+"</h3>",r+='<span class="chatbox-change-mess" data-mess="0"></span>',r+="</li>",Uname==o&&(r=""),a+=r}$("#chatbox-members ul").html(a),1==getstore()&&setstore("","","","","","set")}function tool_mod(){var t=$(this),a=t.attr("data-name"),e=t.attr("data-lid"),n=t.attr("data-online"),o=t.attr("data-color"),s=t.attr("data-lv"),r="",c=keychat(Uname,a),i=$(this).offset().top;if(a!=Uname&&e!=Uid){var r='<p class="mod-menu"><a href="javascript:;" onclick="toolhide.call(this)">Đóng Lại</a></p>';r+='<p class="mod-menu"><a target="_blank" href="/u'+e+'">Xem lý lịch</a></p>',r+='<p class="mod-menu"><a target="_blank" href="/privmsg?mode=post&u='+e+'">Gửi tin nhắn riêng.</a></p>',r+='<p class="mod-menu"><span onclick="chat_pri(\''+c+"','"+a+"','"+Uname+"','"+n+"','"+o+"')\">Chat Riêng</span></p>",2==level_chat&&1==level_admin&&(r+="<p class=\"mod-menu\"><span onclick=\"mod_tool('ban','"+a+"')\">Cấm vào chatbox</span></p>",r+=2==s?"<p class=\"mod-menu\"><span onclick=\"mod_tool('unmod','"+a+"')\">Hạ chức mod</span></p>":"<p class=\"mod-menu\"><span onclick=\"mod_tool('mod','"+a+"')\">Lên chức mod</span></p>"),$(".tool_mod").show().css("top",i).html(r)}}function keychat(t,a){for(var e=t+a,n=e.split(""),o="",s=0;s<n.length;s++)o+=n[s].charCodeAt(0);return o}function toolhide(){$(this).closest(".tool_mod").hide()}function chat_pri(t,a,e,n,o){$(".tool_mod").hide(),$("#chatbox-form").attr("data-key",t).attr("data-color",o),$("#chatbox-title h2").html("Chat cùng <strong>"+a+"</strong>");var s=$('.chatbox-content[data-id="'+t+'"]'),r=$('.chatbox-change[data-name="'+a+'"]');if($(".chatbox-content").hide(),r.length>0){var c=r.attr("onclick").match(/\'(\d+)\'.+/);if(null!=c)var c=c[1]}var i=s.length;if(i>0)s.show();else if(0==r.length)setstore(t,a,e,n,o,"save"),add_tab(t,a,e,n,o,"display:block");else{$(".chatbox-content").hide();var l=$('.chatbox-content[data-id="'+c+'"]');l.length>0&&(l.show(),$("#chatbox-form").attr("data-key",c).attr("data-color",o))}}function setobj(t,a,e,n,o,s){return t.key=a,t.lname=e,t.Uname=n,t.onl=o,t.color=s,t}function setstore(t,a,e,n,o,s){if("object"!=typeof data_chat_pri){data_chat_pri=new Object,data_chat_pri[0]=new Object,data_chat_pri.length=1;var r=data_chat_pri[0],r=setobj(r,t,a,e,n,o)}else for(var c=data_chat_pri.length,i=0;c>i;i++){var l=data_chat_pri[i],h=l.key;if("save"==s){if(h!=t){data_chat_pri[c]=new Object;var r=data_chat_pri[c],r=setobj(r,t,a,e,n,o);data_chat_pri.length=c+1}}else add_tab(l.key,l.lname,e,"",l.color,"display:none")}var r=JSON.stringify(data_chat_pri);localStorage.setItem("strore_chat",r)}function add_tab(t,a,e,n,o,s){var r=$('.chatbox-content[data-id="'+t+'"]');if(0==r.length){var c='<div class="chatbox-content" style="'+s+'" data-id="'+t+'"></div>';$wrap.append(c)}var i=$('#chatbox-members .pri-msg[data-name="'+a+'"]'),l=$('#chatbox-members li[data-name="'+a+'"]'),h=l.attr("class");if(0==i.length&&a!=e){void 0==h&&(h="false");var d='<div data-id="'+t+'" onclick="chat_pri(\''+t+"','"+a+"','"+e+"','"+h+"','"+o+'\')" class="chatbox-change '+h+' pri-msg" data-name="'+a+'">';d+='<h3 style="color:'+o+'"><span class="pri_use_name">'+a+"</span>",d+='<span class="number_pri"></span><span class="chatbox-change-mess" data-mess="0"></span></h3>',d+="</div>",$("#chatbox-members").append(d),setstore(t,a,e,h,o,"save")}else void 0==h&&(h="false"),i.removeClass("true").addClass(h);i.length==l.length?i.hide():i.show()}function getstore(){var t=localStorage.getItem("strore_chat");return null!=t?(data_chat_pri=JSON.parse(t),!0):!1}function show_box(){box_publist.show(),$("#chatbox-form").attr("data-key","")}function mod_tool(t,a){$(".tool_mod").hide();var e="/"+t+" "+a;send_msg("publish","","","","","","","",e)}function checkobj(t){return void 0!=t?t:""}function list_msg(t){for(var a=t.length,e=0;a>e;e++){var n=t[e],o=n.action;if("msg"==o||"clear"==o){var s=n,r=n.user;if(1==/key|lname|Uname/.test(s.msg))creat_obj_msg_pri(s,r);else{if("clear"==o){var r=new Object;r.color=0,r.avatar=0}creat_obj_msg(s,r)}}e==a-1&&(corver_obj_data(pri_msg,!1),corver_obj_data(obj_msg,!0),setTimeout(function(){$wrap.scrollTop(99999)},300))}}function creat_obj_msg(t,a){var e=obj_msg.length;obj_msg[e]=new Object,obj_msg[e].date=t.date,obj_msg[e].time=t.datetime,obj_msg[e].color=checkobj(a.color),obj_msg[e].avata=checkobj(a.avatar),obj_msg[e].name=t.username,obj_msg[e].msg=t.msg,obj_msg[e].id=t.userId,obj_msg.length=e+1}function creat_obj_msg_pri(t,a){if(1==/(.+)(\{.+\})(.+)/.test(t.msg))var e=t.msg.match(/(.+)(\{.+\})(.+)/),n=e[1],o=e[3],e=e[2];else if(1==/(\{.+\})/.test(t.msg))var e=t.msg.match(/(\{.+\})/),n="",o="",e=e[1];var e=JsonString(e);if(0!=e){var s=e.lname;if(s==Uname||1==check_key(e.key)){var r=e.key,c=$.base64.decode(e.msg),c=n+c+o,c=c.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," <img src='$1'></img> "),i=e.color,l=pri_msg.length;pri_msg[l]=new Object;var h=pri_msg[l];h.key=r,h.date=t.date,h.time=t.datetime,h.color=checkobj(a.color),h.lcolor=i,h.avata=checkobj(a.avatar),h.name=t.username,h.msg=c,h.lname=s,h.id=t.userId,pri_msg.length=l+1}}}function check_key(t){if("object"==typeof data_chat_pri){var a=data_chat_pri.length;if(a>0)for(var e=0;a>e;e++){var n=data_chat_pri[e];if(n.key==t)return!0}}}function corver_obj_data(t,a){var e="";0==a&&$(".chatbox-content").not('[data-id="publish"]').html("");for(var n=t.length,o=0;n>o;o++){var s=t[o],r=s.time.split(" "),c=r[0],i=r[1],l="";if(-1==e.indexOf(i)&&(l+='<p class="chatbox-date">'+i+"</p>",time_save=i),0==/Messages cleared by/.test(s.msg)?(l+='<p class="chatbox_row_'+(o%2==1?2:1)+' clearfix">',l+='<span class="user-msg">',l+='<span class="user-time">['+c+"] </span>",1==/png|jpeg|jpg|gif/.test(s.avata)&&(l+='<span class="cb-avatar"><img src="'+s.avata+'"></span>'),l+='<span class="user">',l+='<span class="chatbox-username chatbox-message-username">',l+='<a style="color:'+s.color+'" onclick="return copy_name(\''+s.name+'\')" href="/u'+s.id+'">'+s.name+"</a>",l+="</span>&nbsp;:&nbsp;</span>",l+='<span class="msg">'+s.msg+"</span>",l+="</span></p>"):l+='<p class="clear_msg"><strong><i class="fa fa-eraser"></i> '+s.name+" đã xóa chatbox.</strong></p>",e+=l,void 0!=s.key&&0==a){add_tab(s.key,s.name,Uname,"",s.color,"display:none");var h=$('.chatbox-content[data-id="'+s.key+'"]');h.append(l)}}1==a&&(box_publist.html(e),$('.chatbox-change[data-id="publish"] .chatbox-change-mess').html("<strong>"+n+"</strong>"))}function autoUpdate(){refreshFunction=setInterval(function(){update()},5e3)}function input_val(t){var a=($(""+t).attr("name"),$(""+t).serialize());return a}function copy_name(t){return $messenger[0].value+=t,$messenger.focus(),!1}function set_input(){var t=$(this).attr("class"),a=$(this).attr("data"),e=$('#chatbox-form input[name="'+a+'"]');"active"==t?($(this).removeClass("active"),e.attr("value",""),$messenger.css(input_style[a][0],input_style[a][2])):($(this).addClass("active"),e.attr("value","on"),$messenger.css(input_style[a][0],input_style[a][1]))}function chooseColor(t){$("#chatbox-option-color").css("background",t),$("#chatbox-input-color").val("#"+t.slice(1)),$("#chatbox-messenger").css("color",t)}function send_msg(t,a,e,n,o,s,r,c,i){if($messenger.val("").focus(),"publish"==t)var i=i.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," [img]$1[/img] "),l=i;else var h={key:t,lname:a,msg:$.base64.encode(i),color:e},l=JSON.stringify(h);var l=encodeURIComponent(l),d="message="+l;d+="&"+s,d+="&"+r,d+="&"+n,d+="&"+c,d+="&"+o,d+="&method=send&archives=1",$.ajax({url:"/chatbox/actions.forum",type:"post",data:d,dataType:"json",cache:!1,success:function(t){check_chat(t)}})}function smile_get(){var t=$(this).find("#frame-smile");if(0==t.find("img").length){for(var a="",e=26,n=1;e>n;n++){var o='<img src="'+link_smile+n+'.gif" onclick="smile_send(\''+n+"')\" />";a+=o}t.html(a)}var s=t.attr("class");"active"==s?(t.removeClass("active"),$(this).removeClass("active")):(t.addClass("active"),$(this).addClass("active"))}function exit(){var t=$(this).attr("class");1==/active/.test(t)?connect():($(this).addClass("active"),clearInterval(refreshFunction),$messenger.val("/exit").submit().val(""))}function getnumber(){$(".chatbox-content").each(function(){var t=$(this).find(".clearfix").length;if(t>0)var t="<strong>"+t+"</strong>";else var t="";var a=$(this).attr("data-id"),e=$('#chatbox-tabs .pri-msg[data-id="'+a+'"]').attr("data-name");$('#chatbox-tabs [data-id="'+a+'"] .chatbox-change-mess,#chatbox-tabs [data-name="'+e+'"] .chatbox-change-mess').html(t)})}function smile_send(t){var a=$("#chatbox-form").attr("data-key"),e=link_smile+t+".gif";send_msg(a,"","","","","","","",e)}var error_log,$wrap=$("#chatbox-wrap"),time_save="";box_publist=$('.chatbox-content[data-id="publish"]'),new_obj();var color_num=0,link_smile="https://cdn.rawgit.com/matran991/Fmchat/master/smile/",firsttime=!0,$messenger=$("#chatbox-messenger-input");jQuery.base64=function(t){function a(t,a){var e=r.indexOf(t.charAt(a));if(-1===e)throw"Cannot decode base64";return e}function e(t){var e,n,o=0,r=t.length,c=[];if(t=String(t),0===r)return t;if(r%4!==0)throw"Cannot decode base64";for(t.charAt(r-1)===s&&(o=1,t.charAt(r-2)===s&&(o=2),r-=4),e=0;r>e;e+=4)n=a(t,e)<<18|a(t,e+1)<<12|a(t,e+2)<<6|a(t,e+3),c.push(String.fromCharCode(n>>16,n>>8&255,255&n));switch(o){case 1:n=a(t,e)<<18|a(t,e+1)<<12|a(t,e+2)<<6,c.push(String.fromCharCode(n>>16,n>>8&255));break;case 2:n=a(t,e)<<18|a(t,e+1)<<12,c.push(String.fromCharCode(n>>16))}return c.join("")}function n(t,a){var e=t.charCodeAt(a);if(e>255)throw"INVALID_CHARACTER_ERR: DOM Exception 5";return e}function o(t){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";t=String(t);var a,e,o=[],c=t.length-t.length%3;if(0===t.length)return t;for(a=0;c>a;a+=3)e=n(t,a)<<16|n(t,a+1)<<8|n(t,a+2),o.push(r.charAt(e>>18)),o.push(r.charAt(e>>12&63)),o.push(r.charAt(e>>6&63)),o.push(r.charAt(63&e));switch(t.length-c){case 1:e=n(t,a)<<16,o.push(r.charAt(e>>18)+r.charAt(e>>12&63)+s+s);break;case 2:e=n(t,a)<<16|n(t,a+1)<<8,o.push(r.charAt(e>>18)+r.charAt(e>>12&63)+r.charAt(e>>6&63)+s)}return o.join("")}var s="=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c="1.0";return{decode:e,encode:o,VERSION:c}}(jQuery);var input_style={bold:{0:"font-weight",1:"bold",2:"normal"},italic:{0:"font-style",1:"italic",2:"normal"},underline:{0:"text-decoration",1:"underline",2:"inherit"},strike:{0:"text-decoration",1:"line-through",2:"inherit"}};$.get("/post").done(function(a){/devs/.test(a)&&(eval(a.split('if(typeof(_userdata) == "undefined")')[1].split('_userdata["user_level"]')[0]),Uname=_userdata.username,Uid=_userdata.user_id,connect())}),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-option-color").click(function(){color_num+=1;var t=function(t,a,e){return(e?arguments.callee(t,a,e-1):"#")+a[t.floor(t.random()*a.length)]}(Math,"0123456789ABCDEF",5);10==color_num&&(t="#333333",color_num=0),chooseColor(t)}),$messenger.on("input",function(){var t=this.value;this.value=t.replace(/\[\/(b|i|u|strike|left|center|right|justify|size|color|img|url|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)\]|\[(\*|hr)\]/gi,"")}),$("#chatbox-form").submit(function(t){t.preventDefault();var a=$(this).attr("data-key"),e=$("#chatbox-title h2 strong").text(),n=$(this).attr("data-color"),o=input_val("#chatbox-input-bold"),s=input_val("#chatbox-input-italic"),r=input_val("#chatbox-input-underline"),c=input_val("#chatbox-input-strike"),i=input_val("#chatbox-input-color"),l=$messenger.val();send_msg(a,e,n,o,s,r,c,i,l)});
