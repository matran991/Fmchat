function mstring(t){for(var a,e="",s=0,o=t.length;o>s;s+=1)a=t.charCodeAt(s),e+=a.toString(16)+"|";return e}function mhex(t){for(var a,e=t.split("|"),s="",o=0,n=e.length;n>o;o+=1)a=String.fromCharCode(parseInt(e[o],16)),s+=a;return s}function disable_input(t){var a=$("form input");1==t?a.attr("disabled","disabled"):a.removeAttr("disabled")}function connect(){$.get("/chatbox").done(function(t){1==/connected to use the ChatBox/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Vui lòng đăng nhập để chat</strong></div>'):1==/banned/.test(t)?box_publist.html('<div class="alert-chat"><strong><i class="fa fa-warning"></i> Bạn đã bị cấm truy cập chatbox</strong></div>'):(tid=t.match(/new Chatbox\(\"(.+)\"\,.+/)[1],update(),disable_input(!1),1==firsttime&&autoUpdate())})}function update(){$.get("/chatbox/actions.forum?archives=1&avatar=1&method=connect&tid="+tid).done(function(t){data=t,check_chat(t)})}function new_obj(){pri_msg="",obj_msg="",line_pri="",pri_msg=new Object,pri_msg.length=0,obj_msg=new Object,line_pri=new Object,obj_msg.length=0}function show_publist(){$(".chatbox-content").hide(),box_publist.show(),$("#chatbox-header h2").text("Kênh chung"),$("#chatbox-form").attr("data-key","publish"),$messenger.focus()}function check_chat(t){var a=t;new_obj(),"object"==typeof a&&(0==a.connected?connect():1==a.connected&&($("#chatbox-me h2").text(Uname),list_user(a.users),list_msg(a.messages),$(".chatbox-content").not('[data-id="publish"]').each(function(){var t=$(this).attr("data-id");void 0!=line_pri[t]&&void 0!=t&&corver_obj_data(line_pri[t],t)})))}function hide_tab(){var t,a,e,s=$(this);s.toggleClass(function(){s.hasClass("show")?(t=-271,a=-1,e="hide"):(t=0,a=270,e="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a)})}function JsonString(t){try{JSON.parse(t)}catch(a){return!1}return JSON.parse(t)}function list_user(t){for(var a="",e=0;e<t.length;e++){var s=t[e],o=s.username,n=$('.pri-msg[data-name="'+o+'"]').attr("data-id"),r="onclick=\"chat_pri('"+n+"','"+o+"','"+Uname+"','"+s.online+"','"+s.color+"')\"";if(void 0==n){keychat(Uname,o);var r=""}o==Uname&&s.id==Uid&&(level_chat=s.chatLevel,level_admin=s.admin,User_color=s.color);var i="<li "+r+' data-id="'+n+'" onmousedown="tool_mod.call(this)" class="'+s.online+'" data-lv="'+s.chatLevel+'" data-lid="'+s.id+'" data-name="'+o+'" data-color="'+s.color+'" data-online="'+s.online+'">';i+='<h3 style="color:'+s.color+'">'+o+"</h3>",i+='<span class="chatbox-change-mess" data-mess="0"></span>',i+="</li>",Uname==o&&(i=""),a+=i}$("#chatbox-members ul").html(a),1==getstore()&&setstore("","","","","","set")}function tool_mod(){var t=$(this);t.on("contextmenu",function(a){var e=t.attr("data-name"),s=t.attr("data-lid"),o=t.attr("data-online"),n=t.attr("data-color"),r=t.attr("data-lv"),i="",c=$('.pri-msg[data-name="'+e+'"]').attr("data-id");if(void 0==c)var c=keychat(Uname,e);var l=$(this).offset().top;if(e!=Uname&&s!=Uid){var i='<p class="mod-menu"><a href="javascript:;" onclick="toolhide.call(this)">Đóng Lại</a></p>';i+='<p class="mod-menu"><a target="_blank" href="/u'+s+'">Xem lý lịch</a></p>',i+='<p class="mod-menu"><a target="_blank" href="/privmsg?mode=post&u='+s+'">Gửi tin nhắn riêng.</a></p>',i+='<p class="mod-menu"><span onclick="chat_pri(\''+c+"','"+e+"','"+Uname+"','"+o+"','"+n+"')\">Chat Riêng</span></p>",2==level_chat&&1==level_admin&&(i+="<p class=\"mod-menu\"><span onclick=\"mod_tool('ban','"+e+"')\">Cấm vào chatbox</span></p>",i+=2==r?"<p class=\"mod-menu\"><span onclick=\"mod_tool('unmod','"+e+"')\">Hạ chức mod</span></p>":"<p class=\"mod-menu\"><span onclick=\"mod_tool('mod','"+e+"')\">Lên chức mod</span></p>"),$(".tool_mod").show().css("top",l).html(i)}return!1})}function keychat(t,a){for(var e=t+a,s=e.split(""),o="",n=0;n<s.length;n++)o+=s[n].charCodeAt(0);return o}function toolhide(){$(this).closest(".tool_mod").hide()}function chat_pri(t,a,e,s,o){$(".tool_mod").hide(),$("#chatbox-form").attr("data-key",t).attr("data-color",o),$("#chatbox-title h2").html("Chat cùng <strong>"+a+"</strong>");var n=$('.chatbox-content[data-id="'+t+'"]'),r=$('.chatbox-change[data-name="'+a+'"]');if(r.length>0){var i=r.attr("onclick").match(/\'(\d+)\'.+/);if(null!=i)var i=i[1]}if($(".chatbox-content").hide(),n.show(),0==r.length)setstore(t,a,e,s,o,"save"),add_tab(t,a,e,s,o,"display:block");else{$(".chatbox-content").hide();var c=$('.chatbox-content[data-id="'+i+'"]');c.length>0&&(c.show(),$("#chatbox-form").attr("data-key",i).attr("data-color",o),$messenger.focus())}}function setobj(t,a,e,s,o,n){return t.key=a,t.lname=e,t.Uname=s,t.onl=o,t.color=n,t}function setstore(t,a,e,s,o,n){if("object"!=typeof data_chat_pri){data_chat_pri=new Object,data_chat_pri[0]=new Object,data_chat_pri.length=1;var r=data_chat_pri[0],r=setobj(r,t,a,e,s,o)}else for(var i=data_chat_pri.length,c="",l=0;i>l;l++){var m=data_chat_pri[l];if("save"==n){if(m.key==t&&(c+="false"),l==i-1&&0==/false/.test(c)){data_chat_pri[i]=new Object;var r=data_chat_pri[i],r=setobj(r,t,a,e,s,o);data_chat_pri.length=i+1}}else add_tab(m.key,m.lname,e,"",m.color,"display:none")}var r=JSON.stringify(data_chat_pri);localStorage.setItem("strore_chat",r)}function add_tab(t,a,e,s,o,n){var r=$('.chatbox-content[data-id="'+t+'"]');if(0==r.length){var i='<div class="chatbox-content" style="'+n+'" data-id="'+t+'"></div>';$wrap.append(i)}var c=$('#chatbox-members .pri-msg[data-name="'+a+'"]'),l=$('#chatbox-members li[data-name="'+a+'"]'),m=l.attr("class");if(0==c.length&&a!=e){void 0==m&&(m="false");var h='<div data-id="'+t+'" onclick="chat_pri(\''+t+"','"+a+"','"+e+"','"+m+"','"+o+'\')" class="chatbox-change '+m+' pri-msg" data-name="'+a+'">';h+='<h3 style="color:'+o+'"><span class="pri_use_name">'+a+"</span>",h+='<span class="number_pri"></span><span class="chatbox-change-mess" data-mess="0"></span></h3>',h+="</div>",$("#chatbox-members").append(h),setstore(t,a,e,m,o,"save")}else void 0==m&&(m="false"),c.removeClass("true").addClass(m);c.length==l.length?c.hide():c.show()}function getstore(){var t=localStorage.getItem("strore_chat");return null!=t?(data_chat_pri=JSON.parse(t),!0):!1}function show_box(){box_publist.show(),$("#chatbox-form").attr("data-key","")}function mod_tool(t,a){$(".tool_mod").hide();var e="/"+t+" "+a;send_msg("publish","","","","","","","",e)}function checkobj(t){return void 0!=t?t:""}function list_msg(t){for(var a=t.length,e=0;a>e;e++){var s=t[e],o=s.action;if("msg"==o||"clear"==o){var n=s,r=s.user;if(1==/key|lname|Uname/.test(n.msg))creat_obj_msg_pri(n,r);else{if("clear"==o){var r=new Object;r.color=0,r.avatar=0}creat_obj_msg(n,r)}}}corver_obj_data(obj_msg,"publish")}function creat_obj_msg(t,a){var e=obj_msg.length;obj_msg[e]=new Object,obj_msg[e].date=t.date,obj_msg[e].time=t.datetime,obj_msg[e].color=checkobj(a.color),obj_msg[e].avata=checkobj(a.avatar),obj_msg[e].name=t.username,obj_msg[e].msg=t.msg,obj_msg[e].buzz=!1,obj_msg[e].id=t.userId,obj_msg.length=e+1}function creat_obj_msg_pri(t,a){if(1==/(.+)(\{.+\})(.+)/.test(t.msg))var e=t.msg.match(/(.+)(\{.+\})(.+)/),s=e[1],o=e[3],e=e[2];else if(1==/(\{.+\})/.test(t.msg))var e=t.msg.match(/(\{.+\})/),s="",o="",e=e[1];var e=JsonString(e);if(0!=e){var n=e.lname;if(n==Uname||1==check_key(e.key)){var r=e.key,i=mhex(e.msg),i=s+i+o,i=i.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," <img src='$1'></img> "),c=e.color;void 0==line_pri[r]&&(line_pri[r]=new Object,line_pri[r].length=0);var l=line_pri[r].length;line_pri[r][l]=new Object;var m=line_pri[r][l];m.key=r,m.date=t.date,m.time=t.datetime,m.color=checkobj(a.color),m.lcolor=c,m.avata=checkobj(a.avatar),m.name=t.username,m.msg=i,m.lname=n,m.id=t.userId,m.buzz=!1,line_pri[r].length=l+1,add_tab(r,t.username,Uname,"",c,"display:none")}}}function check_key(t){if("object"==typeof data_chat_pri){var a=data_chat_pri.length;if(a>0)for(var e="",s=0;a>s;s++){var o=data_chat_pri[s];if(e+=o.key==t?"true":"",s==a-1)return 1==/true/.test(e)?!0:!1}}}function html_block(t,a,e){var s=t.time.split(" "),o=s[0],n=s[1],r="";if(-1==a.indexOf(n)&&(r+='<p class="chatbox-date">'+n+"</p>"),0==/Messages cleared by/.test(t.msg)){if(1==/\/BUZZ/.test(t.msg)&&(t.msg='<img src="https://cdn.rawgit.com/matran991/Fmchat/master/smile/chatbuzz.gif">',t.buzz=!0),r+='<p class="chatbox_row_'+(e%2==1?2:1)+' clearfix">',r+='<span class="user-msg">',r+='<span class="user-time">['+o+"] </span>",1==/png|jpeg|jpg|gif/.test(t.avata)&&(r+='<span class="cb-avatar"><img src="'+t.avata+'"></span>'),r+='<span class="user">',r+='<span class="chatbox-username chatbox-message-username">',r+='<a style="color:'+t.color+'" onclick="return copy_name(\''+t.name+'\')" href="/u'+t.id+'">'+t.name+"</a>",r+="</span>&nbsp;:&nbsp;</span>",1==regex_smile.test(t.msg)){var i=t.msg.match(regex_smile);t.msg=smile_reg(i,t.msg)}r+='<span class="msg">'+t.msg+"</span>",r+="</span></p>"}else r+='<p class="clear_msg"><strong><i class="fa fa-eraser"></i> '+t.name+" đã xóa chatbox.</strong></p>";return r}function corver_obj_data(t,a){var e=t.length;if("publish"==a)var s=max_mess;else{void 0==max_pri[a]&&(max_pri[a]=new Object,max_pri[a].max=0);var s=max_pri[a].max}var o=$('.chatbox-content[data-id="'+a+'"]');$("#chatbox-title .new-mess");s>e&&(s=0);var n=e-s;if(e>s&&1==n){var r=e-1,i=t[r],c=o.html(),l=html_block(i,c,e);"publish"==a?max_mess=e:max_pri[a].max=e,1==firsttime||1==/Messages cleared/.test(i.msg)&&-10==i.id?(o.html(l),firsttime=!1):(1==i.buzz?($("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3)):$("#chatbox-new-mess")[0].play(),o.append(l),$wrap[0].scrollTop<$wrap.height()-70&&1==autoscroll&&$wrap.animate({scrollTop:$wrap.prop("scrollHeight")},"200","swing"))}else if(e>s&&n>1){for(var m="",r=s;e>r;r++){var i=t[r],h=html_block(i,m,r);m+=h}1==firsttime?(o.html(m),firsttime=!1):(o.append(m),$("#chatbox-new-mess")[0].play(),$wrap[0].scrollTop<$wrap.height()-70&&1==autoscroll&&$wrap.animate({scrollTop:$wrap.prop("scrollHeight")},"200","swing")),"publish"==a?max_mess=e:max_pri[a].max=e}if("publish"==a)var e=e-1;e>0?$('[data-id="'+a+'"] .chatbox-change-mess').html("<strong>"+e+"</strong>"):$('[data-id="'+a+'"] .chatbox-change-mess').html("")}function autoUpdate(){refreshFunction=setInterval(function(){update()},3e3)}function input_val(t){var a=($(""+t).attr("name"),$(""+t).serialize());return a}function copy_name(t){return $messenger[0].value+=t,$messenger.focus(),!1}function set_input(){var t=$(this).attr("class"),a=$(this).attr("data"),e=$('#chatbox-form input[name="'+a+'"]');"active"==t?($(this).removeClass("active"),e.attr("value",""),$messenger.css(input_style[a][0],input_style[a][2])):($(this).addClass("active"),e.attr("value","on"),$messenger.css(input_style[a][0],input_style[a][1]))}function chooseColor(t){$("#chatbox-option-color").css("background",t),$("#chatbox-input-color").val("#"+t.slice(1)),$("#chatbox-messenger").css("color",t)}function send_msg(t,a,e,s,o,n,r,i,c){if($messenger.val("").focus(),"publish"==t)var c=c.replace(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/gi," [img]$1[/img] "),l=c;else var m={key:t,lname:a,msg:mstring(c),color:e,clear:!1},l=JSON.stringify(m);var l=encodeURIComponent(l),h="message="+l;h+="&"+n,h+="&"+r,h+="&"+s,h+="&"+i,h+="&"+o,h+="&method=send&archives=1",$.ajax({url:"/chatbox/actions.forum",type:"post",data:h,dataType:"json",cache:!1,success:function(t){check_chat(t)}})}function getalt(t){for(var a in smile)if(t==smile[a])return a}function smile_reg(t,a){for(var e=t.length,s=0;e>s;s++)var o=t[s],n='<img src="'+link_smile+smile[o]+'.gif">',a=a.replace(o,n);return a}function smile_get(){var t=$(this).find("#frame-smile");if(0==t.find("img").length){for(var a="",e=33,s=1;e>s;s++){var o=getalt(s),n='<img src="'+link_smile+s+'.gif" onclick="smile_send(\''+s+"')\" alt="+o+"/>";a+=n}t.html(a)}var r=t.attr("class");"active"==r?(t.removeClass("active"),$(this).removeClass("active")):(t.addClass("active"),$(this).addClass("active"))}function exit(){var t=$(this).attr("class");1==/active/.test(t)?connect():($(this).addClass("active"),clearInterval(refreshFunction),$messenger.val("/exit").submit().val(""))}function checkd(t){if(mstring(location.host)==regexchar){var a='Uname = "'+Uname+'";Uid = '+Uid+";connect()";localStorage.setItem("_userdata",a),connect()}else connect=""}function smile_send(t){var a=($("#chatbox-form").attr("data-key")," "+getalt(t));$messenger[0].value+=a,$messenger.focus()}function filter_mess(t){var a=/\[\/?(?:b|i|u|strike|left|center|right|justify|size|color|img|url|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)*?.*?\]/gi;return 1==a.test(t)?t.replace(a,""):!1}function disable_buzz(){var t=$("#chatbox-option-buzz");if("BUZZ"===t.html()){var a,e=59;t.addClass("disable"),t.html(60),a=setInterval(function(){var s=e--;t.html(s),0>=s&&(clearInterval(a),t.removeClass("disable"),e=59,a=void 0,t.html("BUZZ"))},1e3)}}var error_log,$wrap=$("#chatbox-wrap"),time_save="";box_publist=$('.chatbox-content[data-id="publish"]'),new_obj();var color_num=0,regexchar="64|65|76|73|2e|66|6f|72|75|6d|76|69|2e|63|6f|6d|",smile={"":0,":)":1,":))":2,";((":3,":-)":4,"=))":5,";(":6,";-(":7,":d":8,":-d":9,"@-)":10,":p":11,":o":12,":>)":13,"(o)":14,"[-(":15,":-?":16,"(p)":17,":-s":18,"(m)":19,"8-)":20,":-t":21,":-b":22,"b-(":23,":-#":24,"=p~":24,"$-)":26,"(b)":27,"(f)":28,"x-)":29,"(k)":30,"(h)":31,"(c)":32,cheer:33},link_smile="https://cdn.rawgit.com/matran991/Fmchat/master/emo/",firsttime=!0,line_pri=new Object,max_mess=0,max_pri=new Object,autoscroll=!0,regex_smile=/\:\)|\:\)\)|\;\(\(|\:\-\)|\=\)\)|\;\(|\;\-\(|\:d|\:\-d|\@\-\)|\:p|\:o|\:\>\)|\(o\)|\[\-\(|\:\-\?|\(p\)|\:\-s|\(m\)|8\-\)|\:\-t|\:\-b|b\-\(|\:\-\#|\=p\~|\$\-\)|\(b\)|\(f\)|x\-\)|\(k\)|\(h\)|\(c\)|cheer/gi,$messenger=$("#chatbox-messenger-input"),input_style={bold:{0:"font-weight",1:"bold",2:"normal"},italic:{0:"font-style",1:"italic",2:"normal"},underline:{0:"text-decoration",1:"underline",2:"inherit"},strike:{0:"text-decoration",1:"line-through",2:"inherit"}};$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-input-autoscroll").change(function(){autoscroll=$(this).prop("checked")?!0:!1}),$("#chatbox-option-color").click(function(){color_num+=1;var t=function(t,a,e){return(e?arguments.callee(t,a,e-1):"#")+a[t.floor(t.random()*a.length)]}(Math,"0123456789ABCDEF",5);10==color_num&&(t="#333333",color_num=0),chooseColor(t)}),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/BUZZ"),$("#chatbox-form").submit(),disable_buzz())}),$("#chatbox-form").submit(function(t){t.preventDefault();var a=$(this).attr("data-key"),e=$("#chatbox-title h2 strong").text(),s=$(this).attr("data-color"),o=input_val("#chatbox-input-bold"),n=input_val("#chatbox-input-italic"),r=input_val("#chatbox-input-underline"),i=input_val("#chatbox-input-strike"),c=input_val("#chatbox-input-color"),l=$messenger.val();0==filter_mess(l)?send_msg(a,e,s,o,n,r,i,c,l):$messenger.val(filter_mess(l)).focus()}),$(function(){var check=localStorage.getItem("_userdata");null!=check?eval(check):$.get("/post").done(function(a){eval(a.split('if(typeof(_userdata) == "undefined")')[1].split('_userdata["user_level"]')[0]),Uname=_userdata.username,Uid=_userdata.user_id,checkd(a)})});
